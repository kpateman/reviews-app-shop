{% comment %}
  Standalone Review Form Block
  Can be placed anywhere to collect reviews
{% endcomment %}

<div class="review-form-block"
     data-product-id="{{ product.id | prepend: 'gid://shopify/Product/' }}"
     data-product-title="{{ product.title | escape }}">

  <h3 class="form-title">{{ block.settings.title }}</h3>

  {% if customer %}
  <form id="standalone-review-form" class="review-form" action="/apps/reviews" method="POST">
    {% if product.id %}
      <input type="hidden" name="productId" value="{{ product.id | prepend: 'gid://shopify/Product/' }}">
      <input type="hidden" name="productTitle" value="{{ product.title | escape }}">
      <input type="hidden" name="type" value="product">
    {% else %}
      <input type="hidden" name="type" value="company">
    {% endif %}
    <input type="hidden" name="customerId" value="{{ customer.id | prepend: 'gid://shopify/Customer/' }}">
    <input type="hidden" name="customerEmail" value="{{ customer.email }}">
    <input type="hidden" name="customerName" value="{{ customer.name | default: customer.email }}">

    <div class="form-group">
      <label>Your Rating</label>
      <div class="star-input" id="standalone-star-input">
        <span class="star" data-rating="1">☆</span>
        <span class="star" data-rating="2">☆</span>
        <span class="star" data-rating="3">☆</span>
        <span class="star" data-rating="4">☆</span>
        <span class="star" data-rating="5">☆</span>
      </div>
      <input type="hidden" name="rating" id="standalone-rating-input" required>
    </div>

    <div class="form-group">
      <label for="standalone-title">Review Title</label>
      <input type="text" id="standalone-title" name="title" required maxlength="100">
      <span class="char-counter" id="standalone-title-counter"></span>
    </div>

    <div class="form-group">
      <label for="standalone-content">Your Review</label>
      <textarea id="standalone-content" name="content" required rows="4"></textarea>
      <span class="char-counter" id="standalone-content-counter"></span>
    </div>

    <div class="form-group">
      <label>Add Photos (optional, max 2)</label>
      <div class="image-upload-container">
        <input type="file" id="standalone-images" accept="image/*" multiple style="display: none;">
        <button type="button" class="add-photo-btn" id="standalone-add-photo-btn">
          + Add Photos
        </button>
        <div id="standalone-image-previews" class="image-previews"></div>
      </div>
      <p class="upload-hint">Images will be reviewed before appearing publicly.</p>
    </div>

    <button type="submit" class="submit-btn">{{ block.settings.button_text }}</button>
    <p class="message" id="standalone-message"></p>
  </form>
  {% else %}
  <p class="login-prompt">Please <a href="/account/login">log in</a> to write a review.</p>
  {% endif %}
</div>

<style>
  .review-form-block {
    padding: 1.5rem;
    background: {{ block.settings.background_color }};
    border-radius: 8px;
  }

  .form-title {
    margin-bottom: 1rem;
  }

  .review-form .form-group {
    margin-bottom: 1rem;
  }

  .review-form label {
    display: block;
    margin-bottom: 0.5rem;
    font-weight: 500;
  }

  .review-form input[type="text"],
  .review-form textarea {
    width: 100%;
    padding: 0.75rem;
    border: 1px solid #ddd;
    border-radius: 4px;
    font-size: 1rem;
  }

  .star-input {
    display: flex;
    gap: 0.25rem;
    font-size: 1.75rem;
    cursor: pointer;
  }

  .star-input .star {
    color: #ddd;
    transition: color 0.2s;
  }

  .star-input .star.active {
    color: #f5a623;
  }

  .submit-btn {
    background: {{ block.settings.button_color }};
    color: #fff;
    border: none;
    padding: 0.75rem 1.5rem;
    border-radius: 4px;
    font-size: 1rem;
    cursor: pointer;
  }

  .submit-btn:disabled {
    opacity: 0.6;
    cursor: not-allowed;
  }

  .message {
    margin-top: 1rem;
    padding: 0.75rem;
    border-radius: 4px;
  }

  .message.success {
    background: #e8f5e9;
    color: #2e7d32;
  }

  .message.error {
    background: #ffebee;
    color: #c62828;
  }

  .login-prompt {
    text-align: center;
  }

  .login-prompt a {
    font-weight: 600;
  }

  .image-upload-container {
    margin-top: 0.5rem;
  }

  .add-photo-btn {
    background: #f5f5f5;
    border: 2px dashed #ccc;
    padding: 0.75rem 1.5rem;
    border-radius: 4px;
    cursor: pointer;
    font-size: 0.9rem;
    transition: all 0.2s;
  }

  .add-photo-btn:hover {
    border-color: #999;
    background: #eee;
  }

  .image-previews {
    display: flex;
    gap: 0.5rem;
    margin-top: 0.75rem;
    flex-wrap: wrap;
  }

  .image-preview {
    position: relative;
    width: 80px;
    height: 80px;
  }

  .image-preview img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    border-radius: 4px;
  }

  .image-preview .remove-btn {
    position: absolute;
    top: -8px;
    right: -8px;
    width: 20px;
    height: 20px;
    background: #e74c3c;
    color: white;
    border: none;
    border-radius: 50%;
    cursor: pointer;
    font-size: 12px;
    line-height: 1;
  }

  .upload-hint {
    font-size: 0.8rem;
    color: #888;
    margin-top: 0.5rem;
  }

  .char-counter {
    display: block;
    margin-top: 0.35rem;
    font-size: 0.8rem;
    color: #999;
    text-align: right;
    opacity: 0;
    transition: opacity 0.3s ease, color 0.3s ease;
  }

  .char-counter.visible {
    opacity: 1;
  }

  .char-counter.warn {
    color: #e67e22;
  }

  .char-counter.over {
    color: #e74c3c;
  }
</style>

<script>
  (function() {
    const apiUrl = '/apps/reviews';

    const starInput = document.getElementById('standalone-star-input');
    const ratingInput = document.getElementById('standalone-rating-input');

    if (starInput) {
      const stars = starInput.querySelectorAll('.star');
      stars.forEach(star => {
        star.addEventListener('click', () => {
          const rating = parseInt(star.dataset.rating);
          ratingInput.value = rating;
          stars.forEach((s, i) => {
            s.textContent = i < rating ? '★' : '☆';
            s.classList.toggle('active', i < rating);
          });
        });
      });
    }

    // Character counters
    const TITLE_MAX = 100;
    const CONTENT_MAX = 1000;

    function setupCounter(inputEl, counterEl, max) {
      if (!inputEl || !counterEl) return;
      const showAt = Math.floor(max * 0.8);
      const warnAt = Math.floor(max * 0.9);

      inputEl.addEventListener('input', () => {
        const len = inputEl.value.length;
        const remaining = max - len;

        if (len >= showAt) {
          counterEl.classList.add('visible');
          if (len > max) {
            counterEl.textContent = `${len.toLocaleString()} / ${max.toLocaleString()} — a little long, trim to submit`;
            counterEl.className = 'char-counter visible over';
          } else if (len >= warnAt) {
            counterEl.textContent = `${remaining.toLocaleString()} character${remaining !== 1 ? 's' : ''} remaining`;
            counterEl.className = 'char-counter visible warn';
          } else {
            counterEl.textContent = `${len.toLocaleString()} / ${max.toLocaleString()}`;
            counterEl.className = 'char-counter visible';
          }
        } else {
          counterEl.classList.remove('visible');
        }
      });
    }

    setupCounter(
      document.getElementById('standalone-title'),
      document.getElementById('standalone-title-counter'),
      TITLE_MAX
    );
    setupCounter(
      document.getElementById('standalone-content'),
      document.getElementById('standalone-content-counter'),
      CONTENT_MAX
    );

    // Image upload handling
    let selectedImages = [];
    const imageInput = document.getElementById('standalone-images');
    const imagePreviews = document.getElementById('standalone-image-previews');
    const addPhotoBtn = document.getElementById('standalone-add-photo-btn');

    if (addPhotoBtn && imageInput) {
      addPhotoBtn.addEventListener('click', () => imageInput.click());
    }

    if (imageInput) {
      imageInput.addEventListener('change', async (e) => {
        const files = Array.from(e.target.files);
        const remaining = 2 - selectedImages.length;
        const newFiles = files.slice(0, remaining);

        for (const file of newFiles) {
          if (file.size > 5 * 1024 * 1024) {
            showMsg('Images must be under 5MB', 'error');
            continue;
          }

          try {
            showMsg('Uploading image...', 'info');
            const fd = new FormData();
            fd.append('file', file);
            fd.append('upload_preset', 'reviews_unsigned');
            fd.append('folder', 'reviews');
            fd.append('tags', 'review,shopify');

            const response = await fetch(
              'https://api.cloudinary.com/v1_1/dkxpqdcyx/image/upload',
              { method: 'POST', body: fd }
            );

            if (!response.ok) throw new Error('Upload failed');
            const data = await response.json();

            selectedImages.push({
              name: file.name,
              url: data.secure_url,
              publicId: data.public_id,
              cloudinaryUrl: true
            });

            renderImagePreviews();
            showMsg('Image uploaded successfully!', 'success');
            setTimeout(() => { document.getElementById('standalone-message').className = 'message'; }, 2000);
          } catch (error) {
            console.error('Upload error:', error);
            showMsg('Failed to upload image. Please try again.', 'error');
          }
        }
        imageInput.value = '';
      });
    }

    function renderImagePreviews() {
      if (!imagePreviews) return;
      imagePreviews.innerHTML = selectedImages.map((img, index) => `
        <div class="image-preview">
          <img src="${img.url}" alt="Preview">
          <button type="button" class="remove-btn" data-index="${index}">×</button>
        </div>
      `).join('');

      imagePreviews.querySelectorAll('.remove-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          selectedImages.splice(parseInt(btn.dataset.index), 1);
          renderImagePreviews();
        });
      });
    }

    const form = document.getElementById('standalone-review-form');
    if (form) {
      form.addEventListener('submit', async (e) => {
        e.preventDefault();

        const formData = new FormData(form);

        if (!formData.get('rating')) {
          showMsg('Please select a rating', 'error');
          return;
        }

        const contentVal = formData.get('content') || '';
        const titleVal = formData.get('title') || '';
        if (titleVal.length > TITLE_MAX) {
          showMsg(`Title is too long — please keep it under ${TITLE_MAX} characters.`, 'error');
          return;
        }
        if (contentVal.length > CONTENT_MAX) {
          showMsg(`Review is a bit long — please trim it to ${CONTENT_MAX.toLocaleString()} characters.`, 'error');
          return;
        }

        // Add images as JSON
        if (selectedImages.length > 0) {
          formData.set('images', JSON.stringify(selectedImages));
        }

        const btn = form.querySelector('button[type="submit"]');
        btn.disabled = true;
        btn.textContent = 'Submitting...';

        try {
          const response = await fetch(apiUrl, {
            method: 'POST',
            body: formData
          });

          const result = await response.json();

          if (response.ok) {
            showMsg(result.message || 'Thank you for your review!', 'success');
            form.reset();
            selectedImages = [];
            renderImagePreviews();
            starInput.querySelectorAll('.star').forEach(s => {
              s.textContent = '☆';
              s.classList.remove('active');
            });
          } else {
            showMsg(result.error || 'Failed to submit review', 'error');
          }
        } catch (error) {
          showMsg('Failed to submit. Please try again.', 'error');
        } finally {
          btn.disabled = false;
          btn.textContent = '{{ block.settings.button_text }}';
        }
      });
    }

    function showMsg(text, type) {
      const el = document.getElementById('standalone-message');
      if (el) {
        el.textContent = text;
        el.className = `message ${type}`;
      }
    }
  })();
</script>

{% schema %}
{
  "name": "Review Form",
  "target": "section",
  "settings": [
    {
      "type": "text",
      "id": "title",
      "label": "Form Title",
      "default": "Write a Review"
    },
    {
      "type": "text",
      "id": "button_text",
      "label": "Button Text",
      "default": "Submit Review"
    },
    {
      "type": "color",
      "id": "background_color",
      "label": "Background Color",
      "default": "#f9f9f9"
    },
    {
      "type": "color",
      "id": "button_color",
      "label": "Button Color",
      "default": "#000000"
    }
  ]
}
{% endschema %}
