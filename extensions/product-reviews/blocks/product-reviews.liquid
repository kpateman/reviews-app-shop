{% assign block_id = block.id | replace: '-', '' %}
{% assign review_count = product.metafields.reviews_app.review_count.value | default: 0 | times: 1 %}
{% assign skeleton_count = review_count | at_most: 2 %}
{% if product.id %}
  {% assign review_type = 'product' %}
{% else %}
  {% assign review_type = 'company' %}
{% endif %}

<div class="reviews-container reviews-width-{{ block.settings.block_width }} reviews-images-{{ block.settings.image_layout }} reviews-layout-{{ block.settings.layout_style }} reviews-align-{{ block.settings.block_alignment }} reviews-padding-{{ block.settings.block_padding }}"
     id="reviews-container-{{ block_id }}"
     data-product-id="{% if product.id %}{{ product.id | prepend: 'gid://shopify/Product/' }}{% endif %}"
     data-review-type="{{ review_type }}"
     data-block-id="{{ block_id }}">

  <div class="reviews-header">
    <h2 class="reviews-title"></h2>
    <div class="reviews-summary" id="reviews-summary-{{ block_id }}">
      <span class="reviews-average">--</span>
      <span class="reviews-stars">☆☆☆☆☆</span>
      <span class="reviews-count">(0 reviews)</span>
    </div>
  </div>

  <div class="reviews-list" id="reviews-list-{{ block_id }}">
    {% if skeleton_count == 0 %}
    <p class="no-reviews">{% if product.id %}No reviews yet. Be the first to review this product!{% else %}No reviews yet. Be the first to share your experience!{% endif %}</p>
    {% endif %}
    {% for i in (1..skeleton_count) %}
    <div class="review-card skeleton-card" aria-hidden="true">
      <div class="review-card-body">
        <div class="skeleton-row skeleton-name"></div>
        <div class="skeleton-row skeleton-stars"></div>
        <div class="skeleton-row skeleton-title"></div>
        <div class="skeleton-row skeleton-line"></div>
        <div class="skeleton-row skeleton-line"></div>
        <div class="skeleton-row skeleton-line short"></div>
      </div>
      <div class="skeleton-row skeleton-image"></div>
    </div>
    {% endfor %}
    {% if customer %}
    <div class="review-form-slot" id="review-form-slot-{{ block_id }}">
      <h3>Write a Review</h3>
      <form id="review-form-{{ block_id }}" class="review-form" action="/apps/reviews" method="POST">
        {% if product.id %}
          <input type="hidden" name="productId" value="{{ product.id | prepend: 'gid://shopify/Product/' }}">
          <input type="hidden" name="productTitle" value="{{ product.title | escape }}">
          <input type="hidden" name="productHandle" value="{{ product.handle }}">
          <input type="hidden" name="type" value="product">
        {% else %}
          <input type="hidden" name="type" value="company">
        {% endif %}
        <input type="hidden" name="customerId" value="{{ customer.id | prepend: 'gid://shopify/Customer/' }}">
        <input type="hidden" name="customerEmail" value="{{ customer.email }}">
        <input type="hidden" name="customerName" value="{{ customer.name | default: customer.email }}">

        <div class="form-group">
          <label>Rating</label>
          <div class="star-rating-input" id="star-rating-input-{{ block_id }}">
            <span class="star" data-rating="1">☆</span>
            <span class="star" data-rating="2">☆</span>
            <span class="star" data-rating="3">☆</span>
            <span class="star" data-rating="4">☆</span>
            <span class="star" data-rating="5">☆</span>
          </div>
          <input type="hidden" name="rating" id="rating-input-{{ block_id }}" required>
        </div>

        <div class="form-group">
          <label for="review-title-{{ block_id }}">Title</label>
          <input type="text" id="review-title-{{ block_id }}" name="title" required maxlength="100" placeholder="Summarize your experience">
          <span class="char-counter" id="title-counter-{{ block_id }}"></span>
        </div>

        <div class="form-group">
          <label for="review-content-{{ block_id }}">Your Review</label>
          <textarea id="review-content-{{ block_id }}" name="content" required rows="4" placeholder="Share the details of your experience..."></textarea>
          <span class="char-counter" id="content-counter-{{ block_id }}"></span>
        </div>

        <div class="form-group">
          <label>Add Photos (optional, max 2)</label>
          <div class="image-upload-container">
            <input type="file" id="review-images-{{ block_id }}" accept="image/*" multiple style="display: none;">
            <button type="button" class="add-photo-btn" id="add-photo-btn-{{ block_id }}">
              + Add Photos
            </button>
            <div id="image-previews-{{ block_id }}" class="image-previews"></div>
          </div>
          <p class="upload-hint">Images will be reviewed before appearing publicly.</p>
        </div>

        <button type="submit" class="submit-review-btn">Submit Review</button>
        <p class="form-message" id="form-message-{{ block_id }}"></p>
      </form>
    </div>
    {% else %}
    <div class="review-form-slot review-login-prompt" id="review-form-slot-{{ block_id }}">
      <p><a href="{{ routes.account_login_url }}">Log in</a> to write a review</p>
    </div>
    {% endif %}
  </div>
  <div id="reviews-show-more-{{ block_id }}" class="reviews-show-more"></div>

  {% assign avg_rating = product.metafields.reviews_app.average_rating.value | default: 0 | times: 1.0 %}
  {% if product.id and review_count > 0 and avg_rating > 0 %}
    <script>
      (function() {
        var productId = '{{ product.id }}';
        var avgRating = '{{ avg_rating }}';
        var reviewCount = '{{ review_count }}';

        function findProductJsonLd() {
          var scripts = document.querySelectorAll('script[type="application/ld+json"]');
          for (var i = 0; i < scripts.length; i++) {
            try {
              var data = JSON.parse(scripts[i].textContent);
              if (data['@type'] === 'Product' && !data.aggregateRating) {
                return scripts[i];
              }
            } catch (e) {}
          }
          return null;
        }

        function injectRatingData(scriptEl, reviews) {
          try {
            var data = JSON.parse(scriptEl.textContent);
            data.aggregateRating = {
              '@type': 'AggregateRating',
              'ratingValue': avgRating,
              'reviewCount': reviewCount,
              'bestRating': '5',
              'worstRating': '1'
            };
            if (reviews && reviews.length > 0) {
              data.review = reviews.slice(0, 10).map(function(r) {
                return {
                  '@type': 'Review',
                  'reviewRating': {
                    '@type': 'Rating',
                    'ratingValue': String(r.rating),
                    'bestRating': '5',
                    'worstRating': '1'
                  },
                  'author': { '@type': 'Person', 'name': r.customerName },
                  'name': r.title,
                  'reviewBody': r.content,
                  'datePublished': r.createdAt ? r.createdAt.split('T')[0] : undefined
                };
              });
            }
            scriptEl.textContent = JSON.stringify(data);
          } catch (e) {}
        }

        var scriptEl = findProductJsonLd();
        if (!scriptEl) return;

        fetch('/apps/reviews?productId=' + encodeURIComponent(productId) + '&perPage=10')
          .then(function(res) { return res.json(); })
          .then(function(data) {
            injectRatingData(scriptEl, data.reviews || []);
          })
          .catch(function() {
            injectRatingData(scriptEl, []);
          });
      })();
    </script>
  {% endif %}

  {% unless product.id %}
    <script>
      (function() {
        function findOrgJsonLd() {
          var scripts = document.querySelectorAll('script[type="application/ld+json"]');
          for (var i = 0; i < scripts.length; i++) {
            try {
              var data = JSON.parse(scripts[i].textContent);
              if (data['@type'] === 'Organization' && !data.aggregateRating) {
                return scripts[i];
              }
            } catch (e) {}
          }
          return null;
        }

        function injectOrgRatingData(scriptEl, summary, reviews) {
          try {
            var data = JSON.parse(scriptEl.textContent);
            data.aggregateRating = {
              '@type': 'AggregateRating',
              'ratingValue': String(summary.averageRating),
              'reviewCount': String(summary.totalCount),
              'bestRating': '5',
              'worstRating': '1'
            };
            if (reviews && reviews.length > 0) {
              data.review = reviews.slice(0, 10).map(function(r) {
                return {
                  '@type': 'Review',
                  'reviewRating': {
                    '@type': 'Rating',
                    'ratingValue': String(r.rating),
                    'bestRating': '5',
                    'worstRating': '1'
                  },
                  'author': { '@type': 'Person', 'name': r.customerName },
                  'name': r.title,
                  'reviewBody': r.content,
                  'datePublished': r.createdAt ? r.createdAt.split('T')[0] : undefined
                };
              });
            }
            scriptEl.textContent = JSON.stringify(data);
          } catch (e) {}
        }

        function createStandaloneOrgLd(summary, reviews) {
          var ld = {
            '@context': 'https://schema.org',
            '@type': 'Organization',
            'name': {{ shop.name | json }},
            'url': '{{ shop.url }}',
            'aggregateRating': {
              '@type': 'AggregateRating',
              'ratingValue': String(summary.averageRating),
              'reviewCount': String(summary.totalCount),
              'bestRating': '5',
              'worstRating': '1'
            }
          };
          if (reviews && reviews.length > 0) {
            ld.review = reviews.slice(0, 10).map(function(r) {
              return {
                '@type': 'Review',
                'reviewRating': {
                  '@type': 'Rating',
                  'ratingValue': String(r.rating),
                  'bestRating': '5',
                  'worstRating': '1'
                },
                'author': { '@type': 'Person', 'name': r.customerName },
                'name': r.title,
                'reviewBody': r.content,
                'datePublished': r.createdAt ? r.createdAt.split('T')[0] : undefined
              };
            });
          }
          var script = document.createElement('script');
          script.type = 'application/ld+json';
          script.textContent = JSON.stringify(ld);
          document.head.appendChild(script);
        }

        fetch('/apps/reviews?type=company&skip=0&perPage=10')
          .then(function(res) { return res.json(); })
          .then(function(data) {
            if (!data.summary || data.summary.totalCount === 0) return;
            var scriptEl = findOrgJsonLd();
            if (scriptEl) {
              injectOrgRatingData(scriptEl, data.summary, data.reviews || []);
            } else {
              createStandaloneOrgLd(data.summary, data.reviews || []);
            }
          })
          .catch(function() {});
      })();
    </script>
  {% endunless %}

  <div class="image-lightbox" id="image-lightbox-{{ block_id }}" onclick="window.closeLightbox && closeLightbox()">
    <span class="close-btn">&times;</span>
    <img src="" alt="Full size review photo" id="lightbox-image-{{ block_id }}" width="1200" height="800" style="width:auto;height:auto;max-width:90vw;max-height:90vh;">
  </div>
</div>

<style>
  .reviews-container {
    font-family: inherit;
    min-width: 0;
    box-sizing: border-box;
    container-type: inline-size;
    overflow: hidden;
  }

  .reviews-width-narrow .review-card,
  .reviews-width-narrow .review-form-slot { flex: 1 1 180px; max-width: 260px; }
  .reviews-width-medium .review-card,
  .reviews-width-medium .review-form-slot { flex: 1 1 250px; max-width: 350px; }
  .reviews-width-wide .review-card,
  .reviews-width-wide .review-form-slot { flex: 1 1 320px; max-width: 450px; }
  .reviews-width-full .review-card,
  .reviews-width-full .review-form-slot { flex: 1 1 100%; max-width: 100%; }

  .reviews-layout-masonry .reviews-list {
    display: block;
    column-gap: 1rem;
  }
  .reviews-layout-masonry .review-card,
  .reviews-layout-masonry .review-form-slot {
    break-inside: avoid;
    margin-bottom: 1rem;
    max-width: 100%;
  }
  .reviews-layout-masonry .review-images img,
  .reviews-layout-masonry .review-images.single-image img {
    width: 100%;
    max-width: 100%;
    height: auto;
    max-height: none;
  }

  .reviews-layout-masonry.reviews-width-narrow .reviews-list { column-width: 180px; }
  .reviews-layout-masonry.reviews-width-medium .reviews-list { column-width: 250px; }
  .reviews-layout-masonry.reviews-width-wide .reviews-list { column-width: 320px; }
  .reviews-layout-masonry.reviews-width-full .reviews-list { column-width: 100%; }

  .reviews-align-left { margin-left: 0; margin-right: auto; }
  .reviews-align-center { margin-left: auto; margin-right: auto; }
  .reviews-align-right { margin-left: auto; margin-right: 0; }

  .reviews-padding-none { padding: 0; }
  .reviews-padding-small { padding: 1rem 0.5rem; }
  .reviews-padding-medium { padding: 2rem 1rem; }
  .reviews-padding-large { padding: 3rem 1.5rem; }

  .reviews-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1.5rem;
    flex-wrap: wrap;
    gap: 1rem;
  }

  .reviews-title {
    font-size: 1.5rem;
    margin: 0;
  }

  .reviews-summary {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    flex-wrap: wrap;
  }

  .reviews-average {
    font-size: 1.5rem;
    font-weight: bold;
  }

  .reviews-stars {
    color: #f5a623;
    font-size: 1.25rem;
  }

  .reviews-count {
    color: #666;
  }

  @keyframes shimmer {
    0% { background-position: -200px 0; }
    100% { background-position: 200px 0; }
  }

  .skeleton-card {
    pointer-events: none;
    min-height: 320px;
  }

  .reviews-width-full .skeleton-card {
    min-height: 180px;
  }

  .skeleton-row {
    background: linear-gradient(90deg, #eee 25%, #f5f5f5 50%, #eee 75%);
    background-size: 400px 100%;
    animation: shimmer 1.5s ease-in-out infinite;
    border-radius: 4px;
    margin-bottom: 0.6rem;
  }

  .skeleton-name { width: 35%; height: 1rem; }
  .skeleton-stars { width: 45%; height: 1.1rem; }
  .skeleton-title { width: 70%; height: 1rem; margin-top: 0.25rem; }
  .skeleton-line { width: 100%; height: 0.85rem; }
  .skeleton-line.short { width: 60%; }
  .skeleton-image { width: 100%; height: 140px; border-radius: 6px; margin-top: 0.5rem; }

  .reviews-show-more {
    text-align: center;
    margin-bottom: 1.5rem;
  }

  .show-more-btn {
    background: none;
    border: 1px solid #ccc;
    padding: 0.6rem 1.5rem;
    border-radius: 4px;
    font-size: 0.95rem;
    cursor: pointer;
    color: #444;
    transition: border-color 0.2s, color 0.2s;
  }

  .show-more-btn:hover {
    border-color: #888;
    color: #000;
  }

  .show-more-btn:disabled {
    opacity: 0.6;
    cursor: not-allowed;
  }

  .reviews-list {
    display: flex;
    flex-wrap: wrap;
    gap: 1rem;
    align-items: flex-start;
    margin-bottom: 1rem;
  }

  .review-form-slot {
    border: 1px solid #e5e5e5;
    border-radius: 8px;
    padding: 1.25rem;
    box-sizing: border-box;
  }

  .review-form-slot h3 {
    margin: 0 0 1rem 0;
  }

  .review-card {
    border: 1px solid #e5e5e5;
    border-radius: 8px;
    padding: 1rem;
    box-sizing: border-box;
    overflow: hidden;
  }

  .review-card-body {
    min-width: 0;
  }

  .reviews-images-beside .review-card-body {
    display: flex;
    gap: 1rem;
    align-items: flex-start;
  }

  .reviews-images-beside .review-card-content {
    flex: 1 1 0;
    min-width: 0;
  }

  .reviews-images-beside .review-images {
    flex: 0 0 30%;
    max-width: 280px;
    display: block;
    overflow: hidden;
  }

  .reviews-images-beside .review-images img {
    display: block;
    width: 100%;
    height: auto;
    max-height: 220px;
    object-fit: contain;
    margin-bottom: 0.5rem;
  }

  .reviews-images-beside .review-images img:last-child {
    margin-bottom: 0;
  }

  .reviews-images-beside .skeleton-image {
    flex: 0 0 30%;
    max-width: 200px;
    height: 140px;
    margin-top: 0;
  }

  @container (max-width: 480px) {
    .review-card,
    .review-form-slot {
      flex: 1 1 100% !important;
      max-width: 100% !important;
      min-width: 0 !important;
    }

    .reviews-title {
      font-size: 1.25rem;
    }

    .reviews-header {
      flex-direction: column;
      align-items: flex-start;
    }
  }

  .review-card-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 0.75rem;
    flex-wrap: wrap;
    gap: 0.5rem;
  }

  .review-customer-name {
    font-weight: 600;
    margin-bottom: 0.25rem;
  }

  .review-date {
    font-size: 0.85rem;
    color: #666;
  }

  .review-header-right {
    display: flex;
    flex-direction: column;
    align-items: flex-end;
    gap: 0.3rem;
  }

  .review-rating {
    color: #f5a623;
    font-size: 1.1rem;
  }

  .review-title {
    font-weight: 600;
    margin-bottom: 0.5rem;
    font-size: 1.1rem;
  }

  .review-content {
    color: #444;
    line-height: 1.6;
  }

  .verified-badge {
    display: inline-block;
    background: var(--rv-badge-bg, #2e7d32);
    color: var(--rv-badge-text, #ffffff);
    font-size: 0.85rem;
    padding: 0.2rem 0.5rem;
    border-radius: 4px;
  }

  .review-images {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    margin-top: 1rem;
    justify-content: flex-start;
  }

  .review-images img {
    width: auto;
    max-width: 100%;
    max-height: 150px;
    height: auto;
    object-fit: contain;
    border-radius: 6px;
    cursor: pointer;
    transition: transform 0.2s, box-shadow 0.2s;
  }

  .review-images img:hover {
    transform: scale(1.02);
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
  }

  .review-images.single-image img {
    max-height: 200px;
  }

  .image-lightbox {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.9);
    z-index: 9999;
    justify-content: center;
    align-items: center;
    cursor: pointer;
  }

  .image-lightbox.active {
    display: flex;
  }

  .image-lightbox img {
    max-width: 90%;
    max-height: 90%;
    object-fit: contain;
    border-radius: 4px;
  }

  .image-lightbox .close-btn {
    position: absolute;
    top: 20px;
    right: 30px;
    color: white;
    font-size: 2rem;
    cursor: pointer;
  }

  .review-reply {
    margin-top: 1rem;
    padding: 1rem;
    background: #f0f4f8;
    border-left: 3px solid #3498db;
    border-radius: 0 4px 4px 0;
  }

  .reply-header {
    font-weight: 600;
    color: #2c3e50;
    margin-bottom: 0.5rem;
  }

  .reply-content {
    color: #444;
    line-height: 1.5;
  }

  .no-reviews {
    text-align: center;
    padding: 2rem;
    color: #666;
    background: #f9f9f9;
    border-radius: 8px;
    flex: 1 1 100%;
  }

  .form-group {
    margin-bottom: 1rem;
  }

  .form-group label {
    display: block;
    margin-bottom: 0.5rem;
    font-weight: 500;
  }

  .form-group input,
  .form-group textarea {
    width: 100%;
    padding: 0.75rem;
    border: 1px solid #ddd;
    border-radius: 4px;
    font-size: 1rem;
    font-family: inherit;
  }

  .form-group textarea {
    resize: vertical;
    min-height: 100px;
  }

  .star-rating-input {
    display: flex;
    gap: 0.25rem;
    font-size: 1.75rem;
    cursor: pointer;
  }

  .star-rating-input .star {
    color: #ddd;
    transition: color 0.2s;
  }

  .star-rating-input .star.active,
  .star-rating-input .star:hover {
    color: #f5a623;
  }

  .submit-review-btn {
    background: #000;
    color: #fff;
    border: none;
    padding: 0.75rem 1.5rem;
    border-radius: 4px;
    font-size: 1rem;
    cursor: pointer;
    transition: background 0.2s;
  }

  .submit-review-btn:hover {
    background: #333;
  }

  .submit-review-btn:disabled {
    background: #999;
    cursor: not-allowed;
  }

  .form-message {
    margin-top: 1rem;
    padding: 0.75rem;
    border-radius: 4px;
  }

  .form-message.success {
    background: #e8f5e9;
    color: #2e7d32;
  }

  .form-message.error {
    background: #ffebee;
    color: #c62828;
  }

  .review-login-prompt {
    text-align: center;
    background: #f9f9f9;
  }

  .review-login-prompt a {
    color: #000;
    font-weight: 600;
  }

  .image-upload-container {
    margin-top: 0.5rem;
  }

  .add-photo-btn {
    background: #f5f5f5;
    border: 2px dashed #ccc;
    padding: 0.75rem 1.5rem;
    border-radius: 4px;
    cursor: pointer;
    font-size: 0.9rem;
    transition: all 0.2s;
  }

  .add-photo-btn:hover {
    border-color: #999;
    background: #eee;
  }

  .image-previews {
    display: flex;
    gap: 0.5rem;
    margin-top: 0.75rem;
    flex-wrap: wrap;
  }

  .image-preview {
    position: relative;
    width: 80px;
    height: 80px;
  }

  .image-preview img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    border-radius: 4px;
  }

  .image-preview .remove-btn {
    position: absolute;
    top: -8px;
    right: -8px;
    width: 20px;
    height: 20px;
    background: #e74c3c;
    color: white;
    border: none;
    border-radius: 50%;
    cursor: pointer;
    font-size: 12px;
    line-height: 1;
  }

  .upload-hint {
    font-size: 0.8rem;
    color: #888;
    margin-top: 0.5rem;
  }

  .char-counter {
    display: block;
    margin-top: 0.35rem;
    font-size: 0.8rem;
    color: #999;
    text-align: right;
    opacity: 0;
    transition: opacity 0.3s ease, color 0.3s ease;
  }

  .char-counter.visible {
    opacity: 1;
  }

  .char-counter.warn {
    color: #e67e22;
  }

  .char-counter.over {
    color: #e74c3c;
  }
</style>

<script>
  (function() {
    const blockId = '{{ block_id }}';
    const container = document.getElementById('reviews-container-' + blockId);
    if (!container) return;

    const productId = container.dataset.productId || '';
    const reviewType = container.dataset.reviewType || 'product';
    const isProductPage = reviewType === 'product' && productId;
    const apiUrl = '/apps/reviews';

    const INITIAL_PER_PAGE = {{ block.settings.initial_reviews | default: 4 }};
    const LOAD_MORE_PER_PAGE = {{ block.settings.load_more_count | default: 8 }};
    let loadedCount = 0;
    let totalReviews = 0;
    let allLoadedReviews = [];

    function contrastColor(hex) {
      const m = (hex || '#2e7d32').replace('#', '');
      if (m.length !== 6) return '#ffffff';
      const toLinear = c => { const s = parseInt(c, 16) / 255; return s <= 0.04045 ? s / 12.92 : Math.pow((s + 0.055) / 1.055, 2.4); };
      const L = 0.2126 * toLinear(m.slice(0,2)) + 0.7152 * toLinear(m.slice(2,4)) + 0.0722 * toLinear(m.slice(4,6));
      return L > 0.179 ? '#000000' : '#ffffff';
    }

    function applyAppearance(el, ap) {
      if (!ap || !el) return;
      if (ap.badgeColor) {
        el.style.setProperty('--rv-badge-bg', ap.badgeColor);
        el.style.setProperty('--rv-badge-text', contrastColor(ap.badgeColor));
      }
    }

    function renderReviewCard(review) {
      return `
        <div class="review-card">
          <div class="review-card-header">
            <div>
              <div class="review-customer-name">${escapeHtml(review.customerName)}</div>
              <div class="review-date">${new Date(review.createdAt).toLocaleDateString()}</div>
            </div>
            <div class="review-header-right">
              <div class="review-rating">${'★'.repeat(review.rating)}${'☆'.repeat(5 - review.rating)}</div>
              ${review.verifiedPurchase ? '<span class="verified-badge">Verified Purchase</span>' : ''}
            </div>
          </div>
          <div class="review-card-body">
            <div class="review-card-content">
              <div class="review-title">${escapeHtml(review.title)}</div>
              <div class="review-content">${escapeHtml(review.content)}</div>
              ${review.reply ? `
                <div class="review-reply">
                  <div class="reply-header">Store Response:</div>
                  <div class="reply-content">${escapeHtml(review.reply)}</div>
                </div>
              ` : ''}
            </div>
            ${review.images && review.images.length > 0 ? `
              <div class="review-images ${review.images.length === 1 ? 'single-image' : ''}">
                ${review.images.map(img => `<img src="${escapeHtml(img.url)}" alt="Review photo" onclick="openLightbox(this.src)">`).join('')}
              </div>
            ` : ''}
          </div>
        </div>`;
    }

    function updateShowMoreButton() {
      const showMoreEl = document.getElementById('reviews-show-more-' + blockId);
      if (!showMoreEl) return;
      const remaining = totalReviews - loadedCount;
      if (remaining > 0) {
        showMoreEl.innerHTML = `<button class="show-more-btn" id="show-more-btn-${blockId}">Show more reviews (${remaining} more)</button>`;
        document.getElementById('show-more-btn-' + blockId).addEventListener('click', loadMore);
      } else {
        showMoreEl.innerHTML = '';
      }
    }

    async function loadMore() {
      const btn = document.getElementById('show-more-btn-' + blockId);
      if (btn) { btn.disabled = true; btn.textContent = 'Loading...'; }

      try {
        const fetchUrl = isProductPage
          ? `${apiUrl}?productId=${encodeURIComponent(productId)}&type=product&skip=${loadedCount}&perPage=${LOAD_MORE_PER_PAGE}`
          : `${apiUrl}?type=${reviewType}&skip=${loadedCount}&perPage=${LOAD_MORE_PER_PAGE}`;
        const response = await fetch(fetchUrl);
        const data = await response.json();

        if (data.reviews && data.reviews.length > 0) {
          const listEl = document.getElementById('reviews-list-' + blockId);
          const formSlot = document.getElementById('review-form-slot-' + blockId);
          if (listEl) {
            const newHtml = data.reviews.map(renderReviewCard).join('');
            if (formSlot) {
              formSlot.insertAdjacentHTML('beforebegin', newHtml);
            } else {
              listEl.insertAdjacentHTML('beforeend', newHtml);
            }
          }
          allLoadedReviews = allLoadedReviews.concat(data.reviews);
          loadedCount += data.reviews.length;
        }
        updateShowMoreButton();
      } catch (error) {
        console.error('Error loading more reviews:', error);
        if (btn) { btn.disabled = false; btn.textContent = 'Try again'; }
      }
    }

    async function loadReviews() {
      try {
        const fetchUrl = isProductPage
          ? `${apiUrl}?productId=${encodeURIComponent(productId)}&type=product&skip=0&perPage=${INITIAL_PER_PAGE}`
          : `${apiUrl}?type=${reviewType}&skip=0&perPage=${INITIAL_PER_PAGE}`;
        const response = await fetch(fetchUrl);
        const data = await response.json();

        totalReviews = data.summary?.totalCount || data.summary?.count || 0;

        const summaryEl = document.getElementById('reviews-summary-' + blockId);
        if (summaryEl && data.summary) {
          const stars = '★'.repeat(Math.round(data.summary.averageRating)) + '☆'.repeat(5 - Math.round(data.summary.averageRating));
          summaryEl.innerHTML = `
            <span class="reviews-average">${data.summary.averageRating.toFixed(1)}</span>
            <span class="reviews-stars">${stars}</span>
            <span class="reviews-count">(${totalReviews} review${totalReviews !== 1 ? 's' : ''})</span>
          `;
        }

        const listEl = document.getElementById('reviews-list-' + blockId);
        const formSlot = document.getElementById('review-form-slot-' + blockId);
        if (listEl) {
          Array.from(listEl.children).forEach(child => {
            if (child !== formSlot) child.remove();
          });

          if (data.reviews && data.reviews.length > 0) {
            const cardsHtml = data.reviews.map(renderReviewCard).join('');
            if (formSlot) {
              formSlot.insertAdjacentHTML('beforebegin', cardsHtml);
            } else {
              listEl.insertAdjacentHTML('afterbegin', cardsHtml);
            }
            allLoadedReviews = data.reviews;
            loadedCount = data.reviews.length;
            updateShowMoreButton();
          } else {
            const noReviewsMsg = isProductPage ? 'No reviews yet. Be the first to review this product!' : 'No reviews yet. Be the first to share your experience!';
            const noReviewsHtml = '<p class="no-reviews">' + noReviewsMsg + '</p>';
            if (formSlot) {
              formSlot.insertAdjacentHTML('beforebegin', noReviewsHtml);
            } else {
              listEl.insertAdjacentHTML('afterbegin', noReviewsHtml);
            }
          }
        }
        if (data && data.settings && data.settings.appearance) {
          applyAppearance(container, data.settings.appearance);
        }
        if (data && data.settings && data.settings.widgetTitles) {
          const appTitle = isProductPage ? data.settings.widgetTitles.productReviews : data.settings.widgetTitles.siteReviews;
          if (appTitle) {
            const titleEl = container.querySelector('.reviews-title');
            if (titleEl) titleEl.textContent = appTitle;
          }
        }
      } catch (error) {
        console.error('Error loading reviews:', error);
        const listEl = document.getElementById('reviews-list-' + blockId);
        const formSlot = document.getElementById('review-form-slot-' + blockId);
        if (listEl) {
          Array.from(listEl.children).forEach(child => {
            if (child !== formSlot) child.remove();
          });
          const errHtml = '<p class="no-reviews">Unable to load reviews.</p>';
          if (formSlot) {
            formSlot.insertAdjacentHTML('beforebegin', errHtml);
          } else {
            listEl.insertAdjacentHTML('afterbegin', errHtml);
          }
        }
      }
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    if (!window.openLightbox) {
      window.openLightbox = function(src) {
        const lightbox = document.querySelector('.image-lightbox');
        const img = lightbox ? lightbox.querySelector('img') : null;
        if (lightbox && img) {
          img.src = src;
          lightbox.classList.add('active');
          document.body.style.overflow = 'hidden';
        }
      };

      window.closeLightbox = function() {
        const lightbox = document.querySelector('.image-lightbox.active');
        if (lightbox) {
          lightbox.classList.remove('active');
          document.body.style.overflow = '';
        }
      };

      document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') closeLightbox();
      });
    }

    const starInput = document.getElementById('star-rating-input-' + blockId);
    const ratingInput = document.getElementById('rating-input-' + blockId);
    if (starInput) {
      const stars = starInput.querySelectorAll('.star');
      stars.forEach(star => {
        star.addEventListener('click', () => {
          const rating = parseInt(star.dataset.rating);
          ratingInput.value = rating;
          stars.forEach((s, i) => {
            s.textContent = i < rating ? '★' : '☆';
            s.classList.toggle('active', i < rating);
          });
        });
      });
    }

    let selectedImages = [];
    const imageInput = document.getElementById('review-images-' + blockId);
    const imagePreviews = document.getElementById('image-previews-' + blockId);
    const addPhotoBtn = document.getElementById('add-photo-btn-' + blockId);

    if (addPhotoBtn && imageInput) {
      addPhotoBtn.addEventListener('click', () => imageInput.click());
    }

    if (imageInput) {
      imageInput.addEventListener('change', async (e) => {
        const files = Array.from(e.target.files);

        const remaining = 2 - selectedImages.length;
        const newFiles = files.slice(0, remaining);

        for (const file of newFiles) {
          if (file.size > 5 * 1024 * 1024) {
            showMessage('Images must be under 5MB', 'error');
            continue;
          }

          try {
            showMessage('Uploading image...', 'info');
            
            const formData = new FormData();
            formData.append('file', file);
            formData.append('upload_preset', 'reviews_unsigned');
            formData.append('folder', 'reviews');
            formData.append('tags', 'review,shopify');

            const response = await fetch(
              'https://api.cloudinary.com/v1_1/dkxpqdcyx/image/upload',
              {
                method: 'POST',
                body: formData,
              }
            );

            if (!response.ok) {
              throw new Error('Upload failed');
            }

            const data = await response.json();
            
            selectedImages.push({
              name: file.name,
              url: data.secure_url,
              publicId: data.public_id,
              cloudinaryUrl: true
            });
            
            renderImagePreviews();
            showMessage('Image uploaded successfully!', 'success');
          } catch (error) {
            console.error('Upload error:', error);
            showMessage('Failed to upload image. Please try again.', 'error');
          }
        }

        imageInput.value = '';
      });
    }

    function renderImagePreviews() {
      if (!imagePreviews) return;
      imagePreviews.innerHTML = selectedImages.map((img, index) => `
        <div class="image-preview">
          <img src="${img.cloudinaryUrl ? img.url : img.data}" alt="Preview">
          <button type="button" class="remove-btn" data-index="${index}">×</button>
        </div>
      `).join('');

      imagePreviews.querySelectorAll('.remove-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          const idx = parseInt(btn.dataset.index);
          selectedImages.splice(idx, 1);
          renderImagePreviews();
        });
      });
    }

    const TITLE_MAX = 100;
    const CONTENT_MAX = 1000;

    function setupCounter(inputEl, counterEl, max) {
      if (!inputEl || !counterEl) return;
      const showAt = Math.floor(max * 0.8);
      const warnAt = Math.floor(max * 0.9);

      inputEl.addEventListener('input', () => {
        const len = inputEl.value.length;
        const remaining = max - len;

        if (len >= showAt) {
          counterEl.classList.add('visible');
          if (len > max) {
            counterEl.textContent = `${len.toLocaleString()} / ${max.toLocaleString()} — a little long, trim to submit`;
            counterEl.className = 'char-counter visible over';
          } else if (len >= warnAt) {
            counterEl.textContent = `${remaining.toLocaleString()} character${remaining !== 1 ? 's' : ''} remaining`;
            counterEl.className = 'char-counter visible warn';
          } else {
            counterEl.textContent = `${len.toLocaleString()} / ${max.toLocaleString()}`;
            counterEl.className = 'char-counter visible';
          }
        } else {
          counterEl.classList.remove('visible');
        }
      });
    }

    setupCounter(
      document.getElementById('review-title-' + blockId),
      document.getElementById('title-counter-' + blockId),
      TITLE_MAX
    );
    setupCounter(
      document.getElementById('review-content-' + blockId),
      document.getElementById('content-counter-' + blockId),
      CONTENT_MAX
    );

    const form = document.getElementById('review-form-' + blockId);
    if (form) {
      form.addEventListener('submit', async (e) => {
        e.preventDefault();

        const formData = new FormData(form);

        if (!formData.get('rating')) {
          showMessage('Please select a rating', 'error');
          return;
        }

        const contentVal = formData.get('content') || '';
        const titleVal = formData.get('title') || '';
        if (titleVal.length > TITLE_MAX) {
          showMessage(`Title is too long — please keep it under ${TITLE_MAX} characters.`, 'error');
          return;
        }
        if (contentVal.length > CONTENT_MAX) {
          showMessage(`Review is a bit long — please trim it to ${CONTENT_MAX.toLocaleString()} characters.`, 'error');
          return;
        }

        if (selectedImages.length > 0) {
          formData.set('images', JSON.stringify(selectedImages));
        }

        const submitBtn = form.querySelector('button[type="submit"]');
        submitBtn.disabled = true;
        submitBtn.textContent = 'Submitting...';

        try {
          const response = await fetch(apiUrl, {
            method: 'POST',
            body: formData
          });

          const result = await response.json();

          if (response.ok) {
            showMessage(result.message || 'Review submitted successfully!', 'success');
            form.reset();
            selectedImages = [];
            renderImagePreviews();
            if (starInput) {
              const stars = starInput.querySelectorAll('.star');
              stars.forEach(s => { s.textContent = '☆'; s.classList.remove('active'); });
            }
          } else {
            showMessage(result.error || 'Failed to submit review', 'error');
          }
        } catch (error) {
          console.error('Submit error:', error);
          showMessage('Failed to submit review. Please try again.', 'error');
        } finally {
          submitBtn.disabled = false;
          submitBtn.textContent = 'Submit Review';
        }
      });
    }

    function showMessage(text, type) {
      const msgEl = document.getElementById('form-message-' + blockId);
      if (msgEl) {
        msgEl.textContent = text;
        msgEl.className = `form-message ${type}`;
      }
    }

    loadReviews();
  })();
</script>

{% schema %}
{
  "name": "Product Reviews",
  "target": "section",
  "settings": [
    {
      "type": "text",
      "id": "title",
      "label": "Section Title",
      "default": "Customer Reviews"
    },
    {
      "type": "select",
      "id": "block_width",
      "label": "Card Size",
      "default": "medium",
      "options": [
        { "value": "narrow", "label": "Small" },
        { "value": "medium", "label": "Medium" },
        { "value": "wide", "label": "Large" },
        { "value": "full", "label": "Full width" }
      ]
    },
    {
      "type": "select",
      "id": "image_layout",
      "label": "Image position",
      "default": "below",
      "options": [
        { "value": "below", "label": "Below review text" },
        { "value": "beside", "label": "Beside review text" }
      ]
    },
    {
      "type": "select",
      "id": "layout_style",
      "label": "Layout Style",
      "default": "grid",
      "options": [
        { "value": "grid", "label": "Equal height grid" },
        { "value": "masonry", "label": "Masonry (Pinterest-style)" }
      ]
    },
    {
      "type": "select",
      "id": "block_alignment",
      "label": "Alignment",
      "default": "center",
      "options": [
        { "value": "left", "label": "Left" },
        { "value": "center", "label": "Center" },
        { "value": "right", "label": "Right" }
      ]
    },
    {
      "type": "select",
      "id": "block_padding",
      "label": "Padding",
      "default": "medium",
      "options": [
        { "value": "none", "label": "None" },
        { "value": "small", "label": "Small" },
        { "value": "medium", "label": "Medium" },
        { "value": "large", "label": "Large" }
      ]
    },
    {
      "type": "range",
      "id": "initial_reviews",
      "label": "Reviews shown initially",
      "min": 1,
      "max": 20,
      "step": 1,
      "default": 4
    },
    {
      "type": "range",
      "id": "load_more_count",
      "label": "Reviews per 'Show more' click",
      "min": 1,
      "max": 20,
      "step": 1,
      "default": 8
    }
  ]
}
{% endschema %}
