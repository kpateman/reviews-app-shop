{% assign block_id = block.id | replace: '-', '' %}

<div class="photo-gallery-container photo-gallery-padding-{{ block.settings.block_padding }} photo-gallery-align-{{ block.settings.block_alignment }}"
     id="photo-gallery-{{ block_id }}"
     data-block-id="{{ block_id }}"
     data-layout="{{ block.settings.layout }}"
     data-carousel-rows="{{ block.settings.carousel_rows }}"
     data-columns="{{ block.settings.columns }}"
     data-max-photos="{{ block.settings.max_photos }}"
     data-show-more="{{ block.settings.show_more_button }}"
     {% if product.id %}data-product-id="{{ product.id | prepend: 'gid://shopify/Product/' }}"{% endif %}>

  {% if block.settings.title != blank %}
    <h2 class="photo-gallery-title">{{ block.settings.title }}</h2>
    {% if block.settings.subtitle != blank %}
      <p class="photo-gallery-subtitle">{{ block.settings.subtitle }}</p>
    {% endif %}
  {% endif %}

  <div class="photo-gallery-grid photo-gallery-cols-{{ block.settings.columns }}"
       id="photo-gallery-grid-{{ block_id }}"
       {% if block.settings.layout == 'carousel' %}style="display:none"{% endif %}>
    {% for i in (1..block.settings.max_photos) %}
    <div class="photo-gallery-item skeleton-photo" aria-hidden="true">
      <div class="skeleton-photo-inner"></div>
    </div>
    {% endfor %}
  </div>

  <div class="pgal-carousel"
       id="pgal-carousel-{{ block_id }}"
       {% if block.settings.layout != 'carousel' %}style="display:none"{% endif %}>
    <button class="pgal-btn pgal-prev" id="pgal-prev-{{ block_id }}" aria-label="Previous photos">&#8249;</button>
    <div class="pgal-viewport" id="pgal-viewport-{{ block_id }}">
      <div class="pgal-track pgal-rows-{{ block.settings.carousel_rows }}" id="pgal-track-{{ block_id }}">
        {% assign skel_count = 10 %}
        {% if block.settings.carousel_rows == '2' %}{% assign skel_count = 20 %}{% endif %}
        {% for i in (1..skel_count) %}
        <div class="photo-gallery-item skeleton-photo" aria-hidden="true">
          <div class="skeleton-photo-inner"></div>
        </div>
        {% endfor %}
      </div>
    </div>
    <button class="pgal-btn pgal-next" id="pgal-next-{{ block_id }}" aria-label="Next photos">&#8250;</button>
  </div>

  <div id="photo-gallery-empty-{{ block_id }}" class="photo-gallery-empty" style="display: none;">
    <p>No customer photos yet.</p>
  </div>

  <div id="photo-gallery-more-{{ block_id }}" class="photo-gallery-more"></div>

</div>

<style>
  .photo-gallery-container {
    font-family: inherit;
    container-type: inline-size;
  }

  .photo-gallery-padding-none { padding: 0; }
  .photo-gallery-padding-small { padding: 1rem 0.5rem; }
  .photo-gallery-padding-medium { padding: 2rem 1rem; }
  .photo-gallery-padding-large { padding: 3rem 1.5rem; }

  .photo-gallery-title {
    font-size: 1.5rem;
    margin: 0 0 0.25rem 0;
  }

  .photo-gallery-subtitle {
    color: #666;
    margin: 0 0 1.5rem 0;
    font-size: 0.95rem;
  }

  .photo-gallery-align-left .photo-gallery-title,
  .photo-gallery-align-left .photo-gallery-subtitle { text-align: left; }
  .photo-gallery-align-center .photo-gallery-title,
  .photo-gallery-align-center .photo-gallery-subtitle { text-align: center; }
  .photo-gallery-align-right .photo-gallery-title,
  .photo-gallery-align-right .photo-gallery-subtitle { text-align: right; }

  .photo-gallery-grid {
    display: grid;
    gap: 0.5rem;
  }

  .photo-gallery-cols-3 { grid-template-columns: repeat(3, 1fr); }
  .photo-gallery-cols-4 { grid-template-columns: repeat(4, 1fr); }
  .photo-gallery-cols-5 { grid-template-columns: repeat(5, 1fr); }
  .photo-gallery-cols-6 { grid-template-columns: repeat(6, 1fr); }

  @container (max-width: 600px) {
    .photo-gallery-cols-5,
    .photo-gallery-cols-6 { grid-template-columns: repeat(3, 1fr); }
    .photo-gallery-cols-4 { grid-template-columns: repeat(2, 1fr); }
  }

  @container (max-width: 400px) {
    .photo-gallery-grid { grid-template-columns: repeat(2, 1fr) !important; }
  }

  .pgal-carousel {
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .pgal-viewport {
    flex: 1;
    min-width: 0;
    overflow: hidden;
  }

  .pgal-track {
    display: grid;
    grid-auto-flow: column;
    grid-auto-columns: 150px;
    gap: 8px;
    transition: transform 0.3s ease;
  }

  .pgal-rows-1 { grid-template-rows: 150px; }
  .pgal-rows-2 { grid-template-rows: repeat(2, 150px); }

  .pgal-btn {
    flex-shrink: 0;
    width: 36px;
    height: 36px;
    border-radius: 50%;
    border: 1px solid #ddd;
    background: #fff;
    font-size: 1.5rem;
    line-height: 1;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: border-color 0.2s, box-shadow 0.2s;
    user-select: none;
  }

  .pgal-btn:hover:not(:disabled) {
    border-color: #999;
    box-shadow: 0 1px 4px rgba(0,0,0,0.12);
  }

  .pgal-btn:disabled {
    opacity: 0.25;
    cursor: default;
  }

  .photo-gallery-item {
    position: relative;
    aspect-ratio: 1;
    overflow: hidden;
    border-radius: 6px;
    cursor: pointer;
    background: #f5f5f5;
  }

  .pgal-track .photo-gallery-item {
    width: 150px;
    height: 150px;
    aspect-ratio: unset;
  }

  .photo-gallery-item img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    display: block;
    transition: transform 0.3s ease;
  }

  .photo-gallery-item:hover img {
    transform: scale(1.05);
  }

  .photo-gallery-item-overlay {
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    padding: 0.5rem;
    background: linear-gradient(transparent, rgba(0,0,0,0.7));
    color: white;
    opacity: 0;
    transition: opacity 0.3s ease;
    pointer-events: none;
  }

  .photo-gallery-item:hover .photo-gallery-item-overlay {
    opacity: 1;
  }

  .photo-gallery-item-rating {
    font-size: 0.75rem;
    color: var(--rv-star, #f5a623);
  }

  .photo-gallery-item-product {
    font-size: 0.7rem;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    margin-top: 0.15rem;
  }

  .photo-gallery-item-product a {
    color: white;
    text-decoration: none;
    pointer-events: auto;
  }

  .photo-gallery-item-product a:hover {
    text-decoration: underline;
  }

  @keyframes photo-gallery-shimmer {
    0%   { background-position: -200px 0; }
    100% { background-position:  200px 0; }
  }

  .skeleton-photo-inner {
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, #eee 25%, #f5f5f5 50%, #eee 75%);
    background-size: 400px 100%;
    animation: photo-gallery-shimmer 1.5s ease-in-out infinite;
  }

  .photo-gallery-empty {
    text-align: center;
    padding: 2rem;
    color: #666;
  }

  .photo-gallery-more {
    text-align: center;
    margin-top: 1rem;
  }

  .photo-gallery-more-btn {
    background: none;
    border: 1px solid #ccc;
    padding: 0.6rem 1.5rem;
    border-radius: 4px;
    font-size: 0.95rem;
    cursor: pointer;
    color: #444;
    transition: border-color 0.2s, color 0.2s;
  }

  .photo-gallery-more-btn:hover {
    border-color: #888;
    color: #000;
  }
</style>

<script>
  (function() {
    const blockId = '{{ block_id }}';
    const container = document.getElementById('photo-gallery-' + blockId);
    if (!container) return;

    const layout        = container.dataset.layout || 'grid';
    const carouselRows  = container.dataset.carouselRows || '1';
    const maxPhotos     = parseInt(container.dataset.maxPhotos) || 12;
    const showMoreEnabled = container.dataset.showMore === 'true';
    const productId     = container.dataset.productId || '';
    const apiUrl        = '/apps/reviews';
    const perPage       = 50;

    let allPhotos     = [];
    let displayedCount = 0;

    function applyAppearance(el, ap) {
      if (!ap || !el) return;
      if (ap.starColor) el.style.setProperty('--rv-star', ap.starColor);
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function renderPhoto(photo) {
      const item = document.createElement('div');
      item.className = 'photo-gallery-item';
      item.setAttribute('data-index', photo._index);

      const img = document.createElement('img');
      img.src = photo.url;
      img.alt = 'Customer photo' + (photo.productTitle ? ' for ' + photo.productTitle : '');
      img.loading = 'lazy';
      img.decoding = 'async';
      img.width = 300;
      img.height = 300;
      item.appendChild(img);

      const overlay = document.createElement('div');
      overlay.className = 'photo-gallery-item-overlay';
      overlay.innerHTML =
        '<div class="photo-gallery-item-rating">' + '\u2605'.repeat(photo.rating) + '\u2606'.repeat(5 - photo.rating) + '</div>' +
        (photo.productTitle
          ? '<div class="photo-gallery-item-product">' +
              (photo.productHandle
                ? '<a href="/products/' + encodeURIComponent(photo.productHandle) + '">' + escapeHtml(photo.productTitle) + '</a>'
                : escapeHtml(photo.productTitle)) +
            '</div>'
          : '');
      item.appendChild(overlay);

      item.addEventListener('click', function(e) {
        if (e.target.tagName === 'A') return;
        if (photo.productHandle) {
          window.location.href = '/products/' + encodeURIComponent(photo.productHandle);
        }
      });

      return item;
    }

    function displayPhotos(photos) {
      const grid = document.getElementById('photo-gallery-grid-' + blockId);
      const skeletons = Array.from(grid.querySelectorAll('.skeleton-photo'));

      if (photos.length === 0) {
        skeletons.forEach(function(s) { s.remove(); });
        grid.style.display = 'none';
        document.getElementById('photo-gallery-empty-' + blockId).style.display = 'block';
        return;
      }

      photos.forEach(function(photo, i) {
        var realItem = renderPhoto(photo);
        if (skeletons[i]) {
          grid.replaceChild(realItem, skeletons[i]);
        } else {
          grid.appendChild(realItem);
        }
      });

      for (var i = photos.length; i < skeletons.length; i++) {
        if (skeletons[i].parentNode === grid) skeletons[i].remove();
      }

      displayedCount = photos.length;
      updateShowMore();
    }

    function updateShowMore() {
      const moreEl = document.getElementById('photo-gallery-more-' + blockId);
      if (!showMoreEnabled) { moreEl.innerHTML = ''; return; }
      const remaining = allPhotos.length - displayedCount;
      if (remaining > 0) {
        moreEl.innerHTML = '<button class="photo-gallery-more-btn">Show more photos (' + remaining + ' more)</button>';
        moreEl.querySelector('button').addEventListener('click', function() {
          var next = allPhotos.slice(displayedCount, displayedCount + maxPhotos);
          var grid = document.getElementById('photo-gallery-grid-' + blockId);
          next.forEach(function(photo) { grid.appendChild(renderPhoto(photo)); });
          displayedCount += next.length;
          updateShowMore();
        });
      } else {
        moreEl.innerHTML = '';
      }
    }

    function renderCarousel(photos) {
      const carouselEl = document.getElementById('pgal-carousel-' + blockId);
      const viewport   = document.getElementById('pgal-viewport-' + blockId);
      const track      = document.getElementById('pgal-track-'    + blockId);
      const prevBtn    = document.getElementById('pgal-prev-'     + blockId);
      const nextBtn    = document.getElementById('pgal-next-'     + blockId);

      track.innerHTML = '';

      if (photos.length === 0) {
        carouselEl.style.display = 'none';
        document.getElementById('photo-gallery-empty-' + blockId).style.display = 'block';
        return;
      }

      photos.forEach(function(photo) {
        track.appendChild(renderPhoto(photo));
      });

      var rows = parseInt(carouselRows) || 1;
      var cols = Math.ceil(photos.length / rows);
      var gapPx = parseFloat(window.getComputedStyle(track).columnGap) || 8;
      var minColSize = 150;

      var currentPage = 0;
      var fitCols = 1;
      var actualColSize = minColSize;
      var pageCount = 1;

      function goToPage(page) {
        currentPage = Math.max(0, Math.min(page, pageCount - 1));
        var pageWidth = fitCols * (actualColSize + gapPx);
        var trackWidth = cols * actualColSize + Math.max(0, cols - 1) * gapPx;
        var maxOffset = Math.max(0, trackWidth - viewport.clientWidth);
        var offset = Math.min(currentPage * pageWidth, maxOffset);
        track.style.transform = 'translateX(-' + offset + 'px)';
        prevBtn.disabled = currentPage === 0;
        nextBtn.disabled = currentPage >= pageCount - 1;
      }

      function applyCarouselSizing() {
        var vpWidth = viewport.clientWidth;
        if (vpWidth <= 0) { setTimeout(applyCarouselSizing, 50); return; }

        var naturalWidth = cols * minColSize + Math.max(0, cols - 1) * gapPx;

        if (naturalWidth <= vpWidth) {
          actualColSize = Math.min(250, Math.floor((vpWidth - Math.max(0, cols - 1) * gapPx) / cols));
          fitCols = cols;
        } else {
          fitCols = Math.max(1, Math.floor((vpWidth + gapPx) / (minColSize + gapPx)));
          actualColSize = Math.floor((vpWidth - (fitCols - 1) * gapPx) / fitCols);
        }

        pageCount = Math.max(1, Math.ceil(cols / fitCols));
        currentPage = Math.min(currentPage, pageCount - 1);

        var trackWidth = cols * actualColSize + Math.max(0, cols - 1) * gapPx;
        track.style.gridAutoColumns  = actualColSize + 'px';
        track.style.gridTemplateRows = 'repeat(' + rows + ', ' + actualColSize + 'px)';
        track.querySelectorAll('.photo-gallery-item').forEach(function(item) {
          item.style.width  = actualColSize + 'px';
          item.style.height = actualColSize + 'px';
        });
        track.style.width = trackWidth + 'px';

        track.style.transition = 'none';
        goToPage(currentPage);
        requestAnimationFrame(function() {
          requestAnimationFrame(function() {
            track.style.transition = '';
          });
        });
      }

      prevBtn.addEventListener('click', function() { goToPage(currentPage - 1); });
      nextBtn.addEventListener('click', function() { goToPage(currentPage + 1); });

      var resizeTimer = null;
      window.addEventListener('resize', function() {
        clearTimeout(resizeTimer);
        resizeTimer = setTimeout(applyCarouselSizing, 100);
      });

      requestAnimationFrame(applyCarouselSizing);
    }

    async function loadPhotos() {
      try {
        var page = 1;
        var hasMore = true;
        var data;

        while (hasMore && allPhotos.length < 200) {
          var fetchUrl = apiUrl + '?withPhotos=1&perPage=' + perPage + '&page=' + page;
          if (productId) {
            fetchUrl += '&productId=' + encodeURIComponent(productId) + '&type=product';
          }
          var response = await fetch(fetchUrl);
          data = await response.json();

          if (data.reviews && data.reviews.length > 0) {
            data.reviews.forEach(function(review) {
              if (review.images) {
                review.images.forEach(function(img) {
                  allPhotos.push({
                    _index: allPhotos.length,
                    url: img.url,
                    rating: review.rating,
                    customerName: review.customerName,
                    productTitle: review.productTitle || '',
                    productHandle: review.productHandle || '',
                    reviewTitle: review.title,
                  });
                });
              }
            });
          }

          hasMore = data.reviews && data.reviews.length === perPage && data.summary && data.summary.totalCount > page * perPage;
          page++;
        }

        var photos = allPhotos.slice(0, maxPhotos);

        if (layout === 'carousel') {
          renderCarousel(photos);
        } else {
          displayPhotos(photos);
        }

        if (data && data.settings && data.settings.appearance) {
          applyAppearance(container, data.settings.appearance);
        }

        if (data && data.settings && data.settings.widgetTitles && data.settings.widgetTitles.photoGallery) {
          var titleEl = document.querySelector('#photo-gallery-' + blockId + ' .photo-gallery-title');
          if (titleEl) titleEl.textContent = data.settings.widgetTitles.photoGallery;
        }
      } catch (error) {
        console.error('Error loading photo gallery:', error);
        if (layout === 'carousel') {
          renderCarousel([]);
        } else {
          displayPhotos([]);
        }
      }
    }

    // Pre-size carousel skeleton items to the same dimensions they'll have once
    // photos load, so there's no height jump when applyCarouselSizing runs.
    function initCarouselSizing() {
      const viewport = document.getElementById('pgal-viewport-' + blockId);
      const track    = document.getElementById('pgal-track-'    + blockId);
      if (!viewport || !track) return;
      const vpWidth = viewport.clientWidth;
      if (vpWidth <= 0) { requestAnimationFrame(initCarouselSizing); return; }
      const rows   = parseInt(carouselRows) || 1;
      const gapPx  = parseFloat(window.getComputedStyle(track).columnGap) || 8;
      const fitCols  = Math.max(1, Math.floor((vpWidth + gapPx) / (150 + gapPx)));
      const colSize  = Math.floor((vpWidth - (fitCols - 1) * gapPx) / fitCols);
      track.style.gridAutoColumns  = colSize + 'px';
      track.style.gridTemplateRows = 'repeat(' + rows + ', ' + colSize + 'px)';
      track.querySelectorAll('.photo-gallery-item').forEach(function(item) {
        item.style.width  = colSize + 'px';
        item.style.height = colSize + 'px';
      });
    }

    if (layout === 'carousel') {
      requestAnimationFrame(initCarouselSizing);
    }

    loadPhotos();
  })();
</script>

{% schema %}
{
  "name": "Photo Gallery",
  "target": "section",
  "settings": [
    {
      "type": "text",
      "id": "title",
      "label": "Title",
      "default": "Customer Photos"
    },
    {
      "type": "text",
      "id": "subtitle",
      "label": "Subtitle",
      "default": "See what our customers are sharing"
    },
    {
      "type": "select",
      "id": "layout",
      "label": "Layout",
      "default": "grid",
      "options": [
        { "value": "grid",     "label": "Grid" },
        { "value": "carousel", "label": "Carousel" }
      ]
    },
    {
      "type": "range",
      "id": "max_photos",
      "label": "Photos to show",
      "min": 6,
      "max": 48,
      "step": 2,
      "default": 12
    },
    {
      "type": "select",
      "id": "carousel_rows",
      "label": "Carousel rows",
      "default": "1",
      "info": "Only applies when Layout is set to Carousel",
      "options": [
        { "value": "1", "label": "1 row" },
        { "value": "2", "label": "2 rows" }
      ]
    },
    {
      "type": "range",
      "id": "columns",
      "label": "Grid columns",
      "info": "Only applies when Layout is set to Grid",
      "min": 3,
      "max": 6,
      "step": 1,
      "default": 4
    },
    {
      "type": "checkbox",
      "id": "show_more_button",
      "label": "Show 'load more' button",
      "info": "Only applies when Layout is set to Grid",
      "default": true
    },
    {
      "type": "select",
      "id": "block_alignment",
      "label": "Alignment",
      "default": "center",
      "options": [
        { "value": "left",   "label": "Left" },
        { "value": "center", "label": "Center" },
        { "value": "right",  "label": "Right" }
      ]
    },
    {
      "type": "select",
      "id": "block_padding",
      "label": "Padding",
      "default": "medium",
      "options": [
        { "value": "none",   "label": "None" },
        { "value": "small",  "label": "Small" },
        { "value": "medium", "label": "Medium" },
        { "value": "large",  "label": "Large" }
      ]
    }
  ]
}
{% endschema %}
