{% comment %}
  Google Reviews Block
  Displays the most recent Google reviews for the store.
  Add this block anywhere in the theme editor.
{% endcomment %}

{% assign block_id = block.id | replace: '-', '' %}

<div class="gr-reviews-wrapper" id="gr-reviews-{{ block_id }}" style="display:none">
  <div class="gr-reviews-header">
    <svg class="gr-reviews-logo" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48" width="20" height="20">
      <path fill="#4285F4" d="M24 9.5c3.1 0 5.8 1.1 8 2.9l6-6C34.5 3.2 29.6 1 24 1 14.8 1 6.9 6.5 3.5 14.4l7 5.4C12.2 13.6 17.6 9.5 24 9.5z"/>
      <path fill="#34A853" d="M46.5 24.5c0-1.6-.1-3.1-.4-4.5H24v8.5h12.7c-.6 3-2.3 5.5-4.8 7.2l7.4 5.7c4.3-4 6.2-9.9 6.2-16.9z"/>
      <path fill="#FBBC05" d="M10.5 28.2A14.6 14.6 0 0 1 9.5 24c0-1.5.3-2.9.7-4.2l-7-5.4A23.9 23.9 0 0 0 0 24c0 3.9.9 7.5 2.5 10.8l8-6.6z"/>
      <path fill="#EA4335" d="M24 47c5.6 0 10.4-1.9 13.9-5.1l-7.4-5.7c-1.8 1.2-4.1 1.9-6.5 1.9-6.4 0-11.8-4.1-13.5-9.9l-8 6.6C6.9 41.5 14.8 47 24 47z"/>
    </svg>
    <span class="gr-reviews-title">{{ block.settings.heading }}</span>
  </div>
  <div class="gr-reviews-list" id="gr-reviews-list-{{ block_id }}"></div>
</div>

<style>
  #gr-reviews-{{ block_id }} {
    font-size: {{ block.settings.font_size }}px;
  }

  #gr-reviews-{{ block_id }} .gr-reviews-header {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin-bottom: 1.25rem;
  }

  #gr-reviews-{{ block_id }} .gr-reviews-title {
    font-size: 1.15em;
    font-weight: 600;
  }

  #gr-reviews-{{ block_id }} .gr-reviews-list {
    display: grid;
    grid-template-columns: repeat({{ block.settings.columns }}, 1fr);
    gap: 1rem;
  }

  /* Stretch the last card to fill the row if it would be alone */
  {% if block.settings.columns == '2' %}
  #gr-reviews-{{ block_id }} .gr-reviews-list .gr-review-card:last-child:nth-child(odd) {
    grid-column: 1 / -1;
  }
  {% elsif block.settings.columns == '3' %}
  #gr-reviews-{{ block_id }} .gr-reviews-list .gr-review-card:last-child:nth-child(3n+1) {
    grid-column: 1 / -1;
  }
  {% endif %}

  @media (max-width: 640px) {
    #gr-reviews-{{ block_id }} .gr-reviews-list {
      grid-template-columns: 1fr;
    }
  }

  #gr-reviews-{{ block_id }} .gr-review-card {
    border-radius: 10px;
    padding: 1.1rem 1.25rem;
    background: #fff;
    box-shadow: 0 1px 4px rgba(0,0,0,0.10), 0 0 0 1px rgba(0,0,0,0.06);
    display: flex;
    flex-direction: column;
    gap: 0.6rem;
  }

  #gr-reviews-{{ block_id }} .gr-review-top {
    display: flex;
    align-items: center;
    gap: 0.65rem;
  }

  #gr-reviews-{{ block_id }} .gr-review-avatar {
    width: 2.2em;
    height: 2.2em;
    border-radius: 50%;
    flex-shrink: 0;
    object-fit: cover;
  }

  #gr-reviews-{{ block_id }} .gr-review-avatar-fallback {
    width: 2.2em;
    height: 2.2em;
    border-radius: 50%;
    background: #4285F4;
    color: #fff;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.9em;
    font-weight: 700;
    flex-shrink: 0;
  }

  #gr-reviews-{{ block_id }} .gr-review-meta {
    flex: 1;
    min-width: 0;
  }

  #gr-reviews-{{ block_id }} .gr-review-author {
    font-weight: 600;
    display: block;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    color: inherit;
    text-decoration: none;
  }

  #gr-reviews-{{ block_id }} .gr-review-author:hover {
    text-decoration: underline;
  }

  #gr-reviews-{{ block_id }} .gr-review-time {
    color: #888;
    font-size: 0.8em;
    margin-top: 1px;
  }

  #gr-reviews-{{ block_id }} .gr-review-stars {
    color: #f5a623;
    font-size: 1.1em;
    letter-spacing: 1px;
  }

  #gr-reviews-{{ block_id }} .gr-review-text {
    color: #444;
    line-height: 1.55;
    font-size: 0.95em;
  }
</style>

<script>
  (function() {
    var blockId = '{{ block_id }}';
    var maxReviews = {{ block.settings.count }};
    var wrapper = document.getElementById('gr-reviews-' + blockId);
    var list = document.getElementById('gr-reviews-list-' + blockId);

    fetch('/apps/reviews?type=company&perPage=1')
      .then(function(r) { return r.json(); })
      .then(function(data) {
        var reviews = data.google && data.google.reviews;
        if (!reviews || reviews.length === 0) return;

        var toShow = reviews.slice(0, maxReviews);
        toShow.forEach(function(rev) {
          var stars = '★'.repeat(rev.rating) + '☆'.repeat(5 - rev.rating);
          var initial = rev.authorName ? rev.authorName.charAt(0).toUpperCase() : '?';

          var avatarHtml = rev.profilePhoto
            ? '<img class="gr-review-avatar" src="' + rev.profilePhoto + '" alt="" loading="lazy">'
            : '<div class="gr-review-avatar-fallback">' + initial + '</div>';

          var authorHtml = rev.authorUrl
            ? '<a href="' + rev.authorUrl + '" target="_blank" rel="noopener noreferrer" class="gr-review-author">' + rev.authorName + '</a>'
            : '<span class="gr-review-author">' + rev.authorName + '</span>';

          var card = document.createElement('div');
          card.className = 'gr-review-card';
          card.innerHTML =
            '<div class="gr-review-top">' +
              avatarHtml +
              '<div class="gr-review-meta">' +
                authorHtml +
                '<div class="gr-review-time">' + (rev.relativeTime || '') + '</div>' +
              '</div>' +
            '</div>' +
            '<div class="gr-review-stars">' + stars + '</div>' +
            (rev.text ? '<div class="gr-review-text">' + rev.text.replace(/</g, '&lt;').replace(/>/g, '&gt;') + '</div>' : '');
          list.appendChild(card);
        });

        wrapper.style.display = '';
      })
      .catch(function() {});
  })();
</script>

{% schema %}
{
  "name": "Google Reviews",
  "target": "section",
  "settings": [
    {
      "type": "text",
      "id": "heading",
      "label": "Heading",
      "default": "Google Reviews"
    },
    {
      "type": "range",
      "id": "count",
      "label": "Number of reviews",
      "min": 1,
      "max": 5,
      "step": 1,
      "default": 5
    },
    {
      "type": "select",
      "id": "columns",
      "label": "Columns",
      "options": [
        { "value": "1", "label": "1 column" },
        { "value": "2", "label": "2 columns" },
        { "value": "3", "label": "3 columns" }
      ],
      "default": "2"
    },
    {
      "type": "range",
      "id": "font_size",
      "label": "Font size",
      "min": 12,
      "max": 20,
      "step": 1,
      "default": 14,
      "unit": "px"
    }
  ]
}
{% endschema %}
